<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- VorteX v1.0-TESTNET - Convex Testnet Version -->
    <title>VorteX DEX - Convex [TESTNET]</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    
    <style>
        .gradient-bg { background: linear-gradient(135deg, #6e00ff 0%, #ff00a8 100%); }
        .card-glass { background: rgba(255, 255, 255, 0.08); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.18); }
        .token-input { background: rgba(0, 0, 0, 0.2); border: 1px solid rgba(255, 255, 255, 0.1); }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .btn-connected { background: #10b981 !important; }
        .btn-connected:hover { background: #059669 !important; }
        
        select { 
            max-width: 100%; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            white-space: nowrap;
            color: white !important;
        }
        select option {
            background: #1f2937 !important;
            color: white !important;
            padding: 8px !important;
        }
        select option:hover {
            background: #374151 !important;
        }
        
        .token-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .token-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(147, 51, 234, 0.5);
        }
        .token-item.selected {
            background: rgba(147, 51, 234, 0.2);
            border-color: rgba(147, 51, 234, 0.8);
        }
        .token-list {
            max-height: 200px;
            overflow-y: auto;
        }
        .delete-btn {
            opacity: 0;
            transition: opacity 0.2s;
        }
        .token-item:hover .delete-btn {
            opacity: 1;
        }
        
        /* Reverse button animation */
        .reverse-btn {
            transition: transform 0.3s ease;
        }
        .reverse-btn:active {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="min-h-screen gradient-bg text-white">
    
    <div id="walletModal" class="modal fixed inset-0 bg-black/80 items-center justify-center z-50">
        <div class="card-glass rounded-2xl p-8 max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
            
            <div id="step1" class="step">
                <h2 class="text-2xl font-bold mb-4">Welcome to VorteX DEX</h2>
                <p class="text-sm text-white/70 mb-6">Connect to the Convex network</p>
                
                <button onclick="showImportAccount()" class="w-full bg-purple-600 hover:bg-purple-700 py-4 rounded-xl font-medium">
                    <div>Import Account</div>
                    <div class="text-xs text-white/60 mt-1">Use your private key to connect</div>
                </button>
            </div>
            
            <div id="stepImport" class="step" style="display:none;">
                <h2 class="text-2xl font-bold mb-4">Import Account</h2>
                <p class="text-sm text-white/70 mb-4">Enter your 64-character private key</p>
                
                <div class="mb-4">
                    <label class="block text-sm mb-2">Private Key</label>
                    <textarea 
                        id="importKey"
                        class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-2 focus:outline-none focus:border-purple-500 h-32 font-mono text-sm"
                        placeholder="Paste 64-character private key"
                    ></textarea>
                    <p class="text-xs text-white/50 mt-1">VorteX never has access to users' private keys</p>
                </div>
                
                <button onclick="doImport()" class="w-full bg-purple-600 hover:bg-purple-700 py-3 rounded-xl font-medium mb-3">
                    Import & Connect
                </button>
                
                <button onclick="backToStart()" class="w-full text-white/70 hover:text-white py-2">Back</button>
            </div>
            
        </div>
    </div>

    <div id="dexInterface" style="display:none;">
        <nav class="container mx-auto px-4 py-6 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <img src="https://tokens.app.pulsex.com/images/tokens/0x95B303987A60C71504D99Aa1b13B4DA07b0790ab.png" alt="VorteX" class="w-10 h-10">
                <span class="text-2xl font-bold">VorteX</span>
                <span class="text-xs bg-orange-600 px-2 py-1 rounded-full ml-2 animate-pulse">TESTNET</span>
            </div>
            
            <div class="flex items-center space-x-4">
                <button id="connectBtn" onclick="disconnect()" class="btn-connected px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-white animate-pulse"></span>
                    <span>Connected: <span id="navAccount">#132</span></span>
                </button>
            </div>
        </nav>

        <main class="container mx-auto px-4 py-12">
            <div class="max-w-md mx-auto card-glass rounded-2xl p-6 shadow-xl">
                <h2 class="text-xl font-bold mb-6">Swap Tokens</h2>
                
                <div class="mb-4">
                    <div class="flex justify-between text-sm mb-2">
                        <span id="payLabel">You pay</span>
                        <span>Balance: <span id="payBalance">Loading...</span></span>
                    </div>
                    <div class="token-input rounded-xl p-4">
                        <div class="flex items-center gap-2 mb-2">
                            <input type="number" id="payAmount" placeholder="0.0" class="bg-transparent flex-1 text-2xl focus:outline-none" onkeyup="calculateSwap()">
                            <button onclick="setMaxAmount()" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                MAX
                            </button>
                        </div>
                        
                        <!-- Currency selector for pay side -->
                        <div id="payCurrencySelector">
                            <div class="bg-white/10 px-3 py-2 rounded-lg">
                                <span class="font-medium">CVM (Convex Coin)</span>
                            </div>
                        </div>
                        
                        <!-- Token selector for pay side (hidden initially) -->
                        <div id="payTokenSelector" style="display:none;">
                            <button onclick="toggleTokenList()" id="payTokenSelectBtn" class="w-full bg-white/10 hover:bg-white/20 px-3 py-2 rounded-lg text-left flex items-center justify-between">
                                <span id="paySelectedTokenText">Select token...</span>
                                <span>‚ñº</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-center my-4">
                    <button onclick="reverseSwap()" class="reverse-btn bg-purple-600 hover:bg-purple-700 p-3 rounded-full transition-all">
                        ‚áÖ
                    </button>
                </div>
                
                <div class="mb-6">
                    <div class="flex justify-between text-sm mb-2">
                        <span id="receiveLabel">You receive (estimated)</span>
                        <span id="receiveBalance"></span>
                    </div>
                    <div class="token-input rounded-xl p-4">
                        <input type="number" id="receiveAmount" placeholder="0.0" class="bg-transparent w-full text-2xl focus:outline-none mb-3" readonly>
                        
                        <!-- Token selector for receive side -->
                        <div id="receiveTokenSelector">
                            <div class="mb-2">
                                <button onclick="toggleTokenList()" id="receiveTokenSelectBtn" class="w-full bg-white/10 hover:bg-white/20 px-3 py-2 rounded-lg text-left flex items-center justify-between">
                                    <span id="receiveSelectedTokenText">Select token...</span>
                                    <span>‚ñº</span>
                                </button>
                            </div>
                            
                            <div id="tokenListPanel" class="token-list mb-3" style="display:none;">
                                <div id="tokenListItems"></div>
                            </div>
                            
                            <div class="flex gap-2">
                                <button onclick="showAddToken()" class="flex-1 bg-white/10 hover:bg-white/20 px-4 py-2 rounded-lg text-sm font-medium">
                                    + Add Token Market
                                </button>
                                <button id="addLiquidityBtn" onclick="showAddLiquidity()" class="flex-1 bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg text-sm font-medium" style="display:none;">
                                    üíß Add Liquidity
                                </button>
                            </div>
                        </div>
                        
                        <!-- CVM display for receive side (hidden initially) -->
                        <div id="receiveCurrencySelector" style="display:none;">
                            <div class="bg-white/10 px-3 py-2 rounded-lg mb-3">
                                <span class="font-medium">CVM (Convex Coin)</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button id="swapBtn" onclick="executeSwap()" class="w-full bg-purple-600 hover:bg-purple-700 py-4 rounded-xl font-medium text-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    <span id="swapBtnText">Select a token to swap</span>
                </button>

                <div id="statusMsg" class="mt-4 p-3 rounded-lg hidden">
                    <p id="statusText" class="text-sm"></p>
                </div>
            </div>
            
            <!-- Pool Information Panel -->
            <div id="poolInfoPanel" class="max-w-md mx-auto mt-6 card-glass rounded-2xl p-6 shadow-xl" style="display:none;">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">Pool Information</h3>
                    <button onclick="refreshPoolInfo()" class="text-sm text-purple-400 hover:text-purple-300">
                        üîÑ Refresh
                    </button>
                </div>
                
                <div class="space-y-4">
                    <!-- Pool Stats -->
                    <div class="bg-white/5 rounded-lg p-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-xs text-white/60 mb-1">Total Liquidity</p>
                                <p class="text-lg font-bold" id="poolTotalLiquidity">Loading...</p>
                            </div>
                            <div>
                                <p class="text-xs text-white/60 mb-1">24h Volume</p>
                                <p class="text-lg font-bold text-white/50">N/A</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Pool Composition -->
                    <div class="bg-white/5 rounded-lg p-4">
                        <p class="text-xs text-white/60 mb-2">Pool Composition</p>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center">
                                <span class="text-sm">CVM</span>
                                <span class="font-mono" id="poolCvmAmount">0.00</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm" id="poolTokenSymbol">TOKEN</span>
                                <span class="font-mono" id="poolTokenAmount">0.00</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Current Price -->
                    <div class="bg-white/5 rounded-lg p-4">
                        <p class="text-xs text-white/60 mb-2">Current Price</p>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center">
                                <span class="text-sm">1 <span id="priceTokenSymbol1">TOKEN</span> =</span>
                                <span class="font-mono text-green-400" id="price1Token">0.00 CVM</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm">1 CVM =</span>
                                <span class="font-mono text-green-400" id="price1Cvm">0.000000 TEST</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Your LP Position -->
                    <div id="lpPositionSection" class="bg-purple-500/10 border border-purple-500/30 rounded-lg p-4" style="display:none;">
                        <p class="text-xs text-purple-300 mb-2">Your Liquidity Position</p>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center">
                                <span class="text-sm">LP Tokens</span>
                                <span class="font-mono" id="userLpTokens">0.00</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm">Pool Share</span>
                                <span class="font-mono text-purple-400" id="userPoolShare">0.00%</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm">Your CVM</span>
                                <span class="font-mono" id="userLpCvm">0.00</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm">Your <span id="userLpTokenSymbol">TOKEN</span></span>
                                <span class="font-mono" id="userLpTokenAmount">0.00</span>
                            </div>
                        </div>
                        
                        <!-- Remove Liquidity Button -->
                        <button onclick="showRemoveLiquidity()" class="w-full mt-4 bg-red-600/80 hover:bg-red-600 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                            üî• Remove Liquidity
                        </button>
                    </div>
                    
                    <div id="noLpPosition" class="text-center text-white/50 text-sm py-2">
                        You don't have any liquidity in this pool
                    </div>
                </div>
            </div>
            
            <!-- Add Liquidity Modal -->
            <div id="addLiquidityModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center" style="display:none; z-index: 1000;">
                <div class="max-w-md mx-4 card-glass rounded-2xl p-6 shadow-xl max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold">üíß Add Liquidity</h3>
                        <button onclick="hideAddLiquidity()" class="text-white/60 hover:text-white text-2xl leading-none">&times;</button>
                    </div>
                    
                    <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-3 mb-4">
                        <p class="text-sm text-blue-300">
                            Adding liquidity to: <strong id="addLiquidityTokenName">TOKEN</strong>
                        </p>
                        <p class="text-xs text-blue-200 mt-1">
                            Market: <span id="addLiquidityMarketAddress" class="font-mono">#000</span>
                        </p>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Token Amount</label>
                            <input type="number" id="addLiqTokenAmount" placeholder="e.g. 1000" min="0" step="0.000001"
                                   class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-2 focus:outline-none focus:border-purple-500"
                                   onkeyup="calculateLiquidityRatio()">
                            <p class="text-xs text-white/50 mt-1">Amount of <span id="addLiqTokenSymbol">TOKEN</span> to add</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">CVM Amount</label>
                            <input type="number" id="addLiqCvmAmount" placeholder="e.g. 1.0" min="0" step="0.000000001"
                                   class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-2 focus:outline-none focus:border-purple-500"
                                   onkeyup="calculateLiquidityRatio()">
                            <p class="text-xs text-white/50 mt-1">Amount of CVM to add</p>
                        </div>
                        
                        <div id="liquidityRatioInfo" class="bg-white/5 rounded-lg p-3 hidden">
                            <p class="text-xs text-white/60 mb-2">Liquidity Ratio</p>
                            <div class="flex justify-between items-center">
                                <span class="text-sm">Current Pool Ratio:</span>
                                <span class="font-mono text-green-400" id="currentPoolRatio">1 TOKEN = 0.00 CVM</span>
                            </div>
                            <div class="flex justify-between items-center mt-1">
                                <span class="text-sm">Your Ratio:</span>
                                <span class="font-mono" id="yourLiquidityRatio">1 TOKEN = 0.00 CVM</span>
                            </div>
                            <div id="ratioWarning" class="hidden mt-2 text-xs text-yellow-300">
                                ‚ö†Ô∏è Your ratio differs from the pool. You may lose value due to price impact.
                            </div>
                        </div>
                        
                        <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-3">
                            <p class="text-xs text-yellow-300">
                                üí° <strong>Tip:</strong> Match the current pool ratio for optimal liquidity provision. The pool will automatically balance based on current prices.
                            </p>
                        </div>
                        
                        <button onclick="executeAddLiquidity()" 
                                class="w-full bg-purple-600 hover:bg-purple-700 px-4 py-3 rounded-lg font-medium">
                            Add Liquidity
                        </button>
                        
                        <div id="addLiquidityStatus" class="hidden p-3 rounded-lg">
                            <p id="addLiquidityStatusText" class="text-sm"></p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Remove Liquidity Modal -->
            <div id="removeLiquidityModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center" style="display:none; z-index: 1000;">
                <div class="max-w-md mx-4 card-glass rounded-2xl p-6 shadow-xl max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold">üî• Remove Liquidity</h3>
                        <button onclick="hideRemoveLiquidity()" class="text-white/60 hover:text-white text-2xl leading-none">&times;</button>
                    </div>
                    
                    <div class="bg-purple-500/10 border border-purple-500/30 rounded-lg p-3 mb-4">
                        <p class="text-sm text-purple-300">
                            Removing liquidity from: <strong id="removeLiquidityTokenName">TOKEN</strong>
                        </p>
                        <p class="text-xs text-purple-200 mt-1">
                            Market: <span id="removeLiquidityMarketAddress" class="font-mono">#000</span>
                        </p>
                    </div>
                    
                    <!-- Current Position Summary -->
                    <div class="bg-white/5 rounded-lg p-4 mb-4">
                        <p class="text-xs text-white/60 mb-2">Your Current Position</p>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center">
                                <span class="text-sm">LP Tokens:</span>
                                <span class="font-mono" id="removeCurrentLpTokens">0.00</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm">Pool Share:</span>
                                <span class="font-mono text-purple-400" id="removeCurrentPoolShare">0.00%</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm">Your CVM:</span>
                                <span class="font-mono" id="removeCurrentCvm">0.00 CVM</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm">Your <span id="removeCurrentTokenSymbol">TOKEN</span>:</span>
                                <span class="font-mono" id="removeCurrentTokenAmount">0.00</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <!-- Percentage Slider -->
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label class="block text-sm font-medium">Amount to Remove</label>
                                <span class="text-lg font-bold text-purple-400" id="removePercentageDisplay">0%</span>
                            </div>
                            <input 
                                type="range" 
                                id="removePercentageSlider" 
                                min="0" 
                                max="100" 
                                value="0" 
                                class="w-full h-2 bg-white/20 rounded-lg appearance-none cursor-pointer"
                                oninput="updateRemovePreview()"
                                style="accent-color: #9333ea;"
                            >
                            <div class="flex justify-between text-xs text-white/50 mt-1">
                                <span>0%</span>
                                <span>25%</span>
                                <span>50%</span>
                                <span>75%</span>
                                <span>100%</span>
                            </div>
                            
                            <!-- Quick percentage buttons -->
                            <div class="flex gap-2 mt-3">
                                <button onclick="setRemovePercentage(25)" class="flex-1 bg-white/10 hover:bg-white/20 py-2 rounded-lg text-xs">25%</button>
                                <button onclick="setRemovePercentage(50)" class="flex-1 bg-white/10 hover:bg-white/20 py-2 rounded-lg text-xs">50%</button>
                                <button onclick="setRemovePercentage(75)" class="flex-1 bg-white/10 hover:bg-white/20 py-2 rounded-lg text-xs">75%</button>
                                <button onclick="setRemovePercentage(100)" class="flex-1 bg-white/10 hover:bg-white/20 py-2 rounded-lg text-xs">MAX</button>
                            </div>
                        </div>
                        
                        <!-- Preview of what you'll receive -->
                        <div id="removePreview" class="bg-green-500/10 border border-green-500/30 rounded-lg p-4 hidden">
                            <p class="text-xs text-green-300 mb-2">You will receive:</p>
                            <div class="space-y-2">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm">CVM:</span>
                                    <span class="font-mono text-green-400" id="removePreviewCvm">0.00 CVM</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm"><span id="removePreviewTokenSymbol">TOKEN</span>:</span>
                                    <span class="font-mono text-green-400" id="removePreviewTokenAmount">0.00</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-3">
                            <p class="text-xs text-yellow-300">
                                ‚ö†Ô∏è <strong>Warning:</strong> Removing liquidity will withdraw your tokens from the pool. You'll receive both CVM and tokens based on the current pool ratio.
                            </p>
                        </div>
                        
                        <button onclick="executeRemoveLiquidity()" id="removeConfirmBtn"
                                class="w-full bg-red-600/80 hover:bg-red-600 px-4 py-3 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled>
                            Remove Liquidity
                        </button>
                        
                        <div id="removeLiquidityStatus" class="hidden p-3 rounded-lg">
                            <p id="removeLiquidityStatusText" class="text-sm"></p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Create Token & Market Modal -->
            <div id="createTokenModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center" style="display:none; z-index: 1000;">
                <div class="max-w-md mx-4 card-glass rounded-2xl p-6 shadow-xl max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold">üöÄ Create Token & Market</h3>
                        <button onclick="hideCreateToken()" class="text-white/60 hover:text-white text-2xl leading-none">&times;</button>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Token Ticker (Symbol)</label>
                            <input type="text" id="newTokenTicker" placeholder="e.g. MOON" maxlength="10" 
                                   class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-2 focus:outline-none focus:border-purple-500">
                            <p class="text-xs text-white/50 mt-1">Short symbol for your token (3-10 characters)</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Total Supply</label>
                            <input type="number" id="newTokenSupply" placeholder="e.g. 1000000" min="1" 
                                   class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-2 focus:outline-none focus:border-purple-500">
                            <p class="text-xs text-white/50 mt-1">Total tokens to mint (uses 6 decimals)</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Initial Token Liquidity</label>
                            <input type="number" id="newTokenLiquidity" placeholder="e.g. 500000" min="0" step="0.000001"
                                   class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-2 focus:outline-none focus:border-purple-500">
                            <p class="text-xs text-white/50 mt-1">Tokens to add to liquidity pool</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Initial CVM Liquidity</label>
                            <input type="number" id="newCvmLiquidity" placeholder="e.g. 1.0" min="0" step="0.000000001"
                                   class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-2 focus:outline-none focus:border-purple-500">
                            <p class="text-xs text-white/50 mt-1">CVM to add to liquidity pool</p>
                        </div>
                        
                        <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-3">
                            <p class="text-xs text-yellow-300">
                                ‚ö†Ô∏è <strong>Important:</strong> Creating a token costs ~0.04 CVM in fees. Make sure you have enough balance!
                            </p>
                        </div>
                        
                        <button onclick="createTokenAndMarket()" 
                                class="w-full bg-purple-600 hover:bg-purple-700 px-4 py-3 rounded-lg font-medium">
                            Create Token & Market
                        </button>
                        
                        <div id="createTokenStatus" class="hidden p-3 rounded-lg">
                            <p id="createTokenStatusText" class="text-sm"></p>
                        </div>
                        
                        <!-- Success Result with Copyable Addresses -->
                        <div id="createTokenResult" class="hidden bg-green-500/10 border border-green-500/30 rounded-lg p-4">
                            <h4 class="font-bold text-green-400 mb-2">‚úÖ Token & Market Created!</h4>
                            <div class="space-y-2 text-sm">
                                <div>
                                    <p class="text-white/60 mb-1">Token Address:</p>
                                    <div class="flex gap-2">
                                        <code id="createdTokenAddress" class="flex-1 bg-black/30 px-3 py-2 rounded font-mono text-green-400"></code>
                                        <button onclick="copyToClipboard('createdTokenAddress')" class="bg-white/10 hover:bg-white/20 px-3 py-2 rounded">
                                            üìã
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <p class="text-white/60 mb-1">Market Address:</p>
                                    <div class="flex gap-2">
                                        <code id="createdMarketAddress" class="flex-1 bg-black/30 px-3 py-2 rounded font-mono text-green-400"></code>
                                        <button onclick="copyToClipboard('createdMarketAddress')" class="bg-white/10 hover:bg-white/20 px-3 py-2 rounded">
                                            üìã
                                        </button>
                                    </div>
                                </div>
                                <div class="bg-white/5 rounded p-3 mt-3">
                                    <p class="text-xs text-white/70 mb-2">üí° <strong>Next Steps:</strong></p>
                                    <p class="text-xs text-white/60">Your token has been created and liquidity added! You can now add it to your token list using the addresses above.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Create Token Modal (From Add Token Panel) -->
            <div id="quickCreateTokenModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center" style="display:none; z-index: 1000;">
                <div class="max-w-md mx-4 card-glass rounded-2xl p-6 shadow-xl max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4 sticky top-0 bg-inherit pb-2">
                        <h3 class="text-xl font-bold">üöÄ Create & List Your Token</h3>
                        <button onclick="hideQuickCreateToken()" class="text-white/60 hover:text-white text-2xl leading-none">&times;</button>
                    </div>
                    
                    <p class="text-sm text-white/70 mb-4">Create a new token and automatically list it on VorteX with initial liquidity</p>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Token Name / Ticker</label>
                            <input type="text" id="quickTokenTicker" placeholder="e.g., ROCKET" maxlength="10" 
                                   class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-2 focus:outline-none focus:border-purple-500">
                            <p class="text-xs text-white/50 mt-1">Your token's symbol (3-10 characters)</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Total Supply</label>
                            <input type="number" id="quickTokenSupply" placeholder="e.g., 1000000" min="1" 
                                   class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-2 focus:outline-none focus:border-purple-500">
                            <p class="text-xs text-white/50 mt-1">Total tokens to create (6 decimals)</p>
                        </div>
                        
                        <div class="bg-purple-500/10 border border-purple-500/30 rounded-lg p-4">
                            <h4 class="text-sm font-semibold mb-3 text-purple-300">Initial Liquidity (Optional)</h4>
                            <p class="text-xs text-white/60 mb-3">Add liquidity to create a trading market immediately</p>
                            
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-xs mb-1">Token Amount for Pool</label>
                                    <input type="number" id="quickTokenLiquidity" placeholder="e.g., 500000" min="0" step="0.000001"
                                           class="w-full bg-white/10 border border-white/20 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-purple-500">
                                </div>
                                
                                <div>
                                    <label class="block text-xs mb-1">CVM Amount for Pool</label>
                                    <input type="number" id="quickCvmLiquidity" placeholder="e.g., 1.0" min="0" step="0.000000001"
                                           class="w-full bg-white/10 border border-white/20 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-purple-500">
                                </div>
                            </div>
                            
                            <p class="text-xs text-purple-300 mt-2">
                                üí° Skip liquidity to just create the token, or add both to enable trading immediately
                            </p>
                        </div>
                        
                        <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-3">
                            <p class="text-xs text-blue-300">
                                <strong>What happens:</strong>
                            </p>
                            <ol class="text-xs text-blue-200 mt-2 space-y-1 ml-4 list-decimal">
                                <li>Token will be created with your supply</li>
                                <li>Remaining tokens sent to your account</li>
                                <li>If liquidity added: Market created on Torus</li>
                                <li>Token automatically added to your VorteX list</li>
                            </ol>
                        </div>
                        
                        <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-3">
                            <p class="text-xs text-yellow-300">
                                ‚ö†Ô∏è <strong>Estimated cost:</strong> ~0.04 CVM for token creation + liquidity amount
                            </p>
                        </div>
                        
                        <button onclick="executeQuickCreateToken()" 
                                class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 px-4 py-3 rounded-lg font-medium">
                            Create Token & List on VorteX
                        </button>
                        
                        <div id="quickCreateStatus" class="hidden p-3 rounded-lg">
                            <p id="quickCreateStatusText" class="text-sm"></p>
                        </div>
                        
                        <!-- Success Result -->
                        <div id="quickCreateResult" class="hidden bg-green-500/10 border border-green-500/30 rounded-lg p-4">
                            <h4 class="font-bold text-green-400 mb-2">‚úÖ Token Created Successfully!</h4>
                            <div class="space-y-2 text-sm">
                                <div>
                                    <p class="text-white/60 mb-1">Token: <span id="quickCreatedTokenName" class="font-bold text-green-400">TOKEN</span></p>
                                    <div class="flex gap-2">
                                        <code id="quickCreatedTokenAddress" class="flex-1 bg-black/30 px-3 py-2 rounded font-mono text-xs text-green-400"></code>
                                        <button onclick="copyToClipboard('quickCreatedTokenAddress')" class="bg-white/10 hover:bg-white/20 px-3 py-2 rounded">
                                            üìã
                                        </button>
                                    </div>
                                </div>
                                <div id="quickCreatedMarketSection" class="hidden">
                                    <p class="text-white/60 mb-1">Market:</p>
                                    <div class="flex gap-2">
                                        <code id="quickCreatedMarketAddress" class="flex-1 bg-black/30 px-3 py-2 rounded font-mono text-xs text-green-400"></code>
                                        <button onclick="copyToClipboard('quickCreatedMarketAddress')" class="bg-white/10 hover:bg-white/20 px-3 py-2 rounded">
                                            üìã
                                        </button>
                                    </div>
                                </div>
                                <div class="bg-white/5 rounded p-3 mt-3">
                                    <p class="text-xs text-green-300">
                                        ‚ú® Your token has been added to VorteX! You can now trade it.
                                    </p>
                                </div>
                                <button onclick="closeQuickCreateSuccess()" class="w-full bg-green-600 hover:bg-green-700 py-2 rounded-lg text-sm">
                                    Start Trading
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="addTokenPanel" class="max-w-md mx-auto mt-6 card-glass rounded-2xl p-6 shadow-xl" style="display:none;">
                <h3 class="text-lg font-bold mb-2">Add Torus Market</h3>
                <p class="text-sm text-white/70 mb-4">Enter the Torus market address and token symbol</p>
                
                <div class="mb-3">
                    <label class="block text-sm mb-2">Token Address</label>
                    <input 
                        type="text" 
                        id="tokenAddressInput" 
                        class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-2 focus:outline-none focus:border-purple-500" 
                        placeholder="e.g., #128"
                    >
                    <p class="text-xs text-white/50 mt-1">The actual token contract</p>
                </div>
                
                <div class="mb-3">
                    <label class="block text-sm mb-2">Market Address</label>
                    <input 
                        type="text" 
                        id="marketAddressInput" 
                        class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-2 focus:outline-none focus:border-purple-500" 
                        placeholder="e.g., #129"
                    >
                    <p class="text-xs text-white/50 mt-1">The Torus market (liquidity pool)</p>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm mb-2">Token Symbol</label>
                    <input 
                        type="text" 
                        id="tokenSymbolInput" 
                        class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-2 focus:outline-none focus:border-purple-500" 
                        placeholder="e.g., USD, GOLD, NESSIE"
                    >
                    <p class="text-xs text-white/50 mt-1">Example: USD token #128, market #129</p>
                </div>
                
                <button onclick="addToken()" class="w-full bg-purple-600 hover:bg-purple-700 py-3 rounded-xl font-medium mb-2">
                    Add Market
                </button>
                <button onclick="hideAddToken()" class="w-full bg-white/10 hover:bg-white/20 py-3 rounded-xl mb-4">
                    Cancel
                </button>
                
                <!-- Divider -->
                <div class="flex items-center my-4">
                    <div class="flex-1 border-t border-white/20"></div>
                    <span class="px-3 text-sm text-white/50">OR</span>
                    <div class="flex-1 border-t border-white/20"></div>
                </div>
                
                <!-- Create Your Own Token Button -->
                <button onclick="showQuickCreateToken()" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 py-3 rounded-xl font-medium flex items-center justify-center gap-2">
                    <span>üöÄ</span>
                    <span>Create Your Own Token & List on VorteX</span>
                </button>
                <p class="text-xs text-white/50 text-center mt-2">
                    Mint a new token and add it to your markets
                </p>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/tweetnacl@1.0.3/nacl-fast.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tweetnacl-util@0.15.1/nacl-util.min.js"></script>

    <script>
        // MAINNET: Change this line to switch between mainnet and testnet
        const CONVEX_URL = 'https://mikera1337-convex-testnet.hf.space';
        
        let wallet = null;
        let account = null;
        let tokens = [];
        let selectedToken = null;
        let swapDirection = 'cvm-to-token'; // or 'token-to-cvm'
        
        window.onload = function() {
            AOS.init();
            feather.replace();
            document.getElementById('walletModal').classList.add('active');
            loadTokens();
            updateCreateOrLiquidityButton(); // Initialize button state
            console.log('‚úì VorteX DEX v2.5.2 initialized - Token Transfer Fix');
        };
        
        // Update the Create/Liquidity button based on whether a token is selected
        function updateCreateOrLiquidityButton() {
            const btn = document.getElementById('createOrLiquidityBtn');
            if (!btn) return;
            
            if (selectedToken) {
                // Token is selected - show "Add Liquidity"
                btn.innerHTML = 'üíß Add Liquidity';
                btn.onclick = showAddLiquidity;
            } else {
                // No token selected - show "Create Token & Market"
                btn.innerHTML = 'üöÄ Create Token & Market';
                btn.onclick = showCreateToken;
            }
        }
        
        // Handle the button click (wrapper function)
        function handleCreateOrLiquidity() {
            if (selectedToken) {
                showAddLiquidity();
            } else {
                showCreateToken();
            }
        }
        
        function showAddLiquidity() {
            if (!selectedToken) {
                showStatus('Please select a token first', 'error');
                return;
            }
            
            // Populate modal with selected token info
            document.getElementById('addLiquidityTokenName').textContent = selectedToken.symbol;
            document.getElementById('addLiquidityMarketAddress').textContent = selectedToken.marketAddress;
            document.getElementById('addLiqTokenSymbol').textContent = selectedToken.symbol;
            
            // Reset form
            document.getElementById('addLiqTokenAmount').value = '';
            document.getElementById('addLiqCvmAmount').value = '';
            document.getElementById('liquidityRatioInfo').classList.add('hidden');
            document.getElementById('addLiquidityStatus').classList.add('hidden');
            
            // Show modal
            document.getElementById('addLiquidityModal').style.display = 'flex';
            
            // Load current pool ratio
            loadCurrentPoolRatio();
        }
        
        function hideAddLiquidity() {
            document.getElementById('addLiquidityModal').style.display = 'none';
        }
        
        async function loadCurrentPoolRatio() {
            if (!selectedToken) return;
            
            try {
                // Get pool info to show current ratio
                const poolInfo = await getPoolInfo(selectedToken.tokenAddress, selectedToken.marketAddress, selectedToken.symbol);
                
                if (poolInfo.tokenBalance > 0 && poolInfo.cvmBalance > 0) {
                    const ratio = poolInfo.pricePerToken;
                    document.getElementById('currentPoolRatio').textContent = 
                        `1 ${selectedToken.symbol} = ${ratio.toFixed(6)} CVM`;
                }
            } catch (error) {
                console.error('Error loading pool ratio:', error);
            }
        }
        
        function calculateLiquidityRatio() {
            const tokenAmount = parseFloat(document.getElementById('addLiqTokenAmount').value) || 0;
            const cvmAmount = parseFloat(document.getElementById('addLiqCvmAmount').value) || 0;
            
            if (tokenAmount > 0 && cvmAmount > 0) {
                const yourRatio = cvmAmount / tokenAmount;
                document.getElementById('yourLiquidityRatio').textContent = 
                    `1 ${selectedToken.symbol} = ${yourRatio.toFixed(6)} CVM`;
                document.getElementById('liquidityRatioInfo').classList.remove('hidden');
                
                // Compare with current pool ratio (if available)
                const currentRatioText = document.getElementById('currentPoolRatio').textContent;
                const currentRatioMatch = currentRatioText.match(/= ([\d.]+) CVM/);
                if (currentRatioMatch) {
                    const currentRatio = parseFloat(currentRatioMatch[1]);
                    const diff = Math.abs(yourRatio - currentRatio) / currentRatio;
                    
                    // Show warning if difference is > 5%
                    if (diff > 0.05) {
                        document.getElementById('ratioWarning').classList.remove('hidden');
                    } else {
                        document.getElementById('ratioWarning').classList.add('hidden');
                    }
                }
            } else {
                document.getElementById('liquidityRatioInfo').classList.add('hidden');
            }
        }
        
        async function executeAddLiquidity() {
            if (!account || !wallet || !selectedToken) {
                showAddLiquidityStatus('Please connect your wallet and select a token', 'error');
                return;
            }
            
            const tokenAmount = parseFloat(document.getElementById('addLiqTokenAmount').value);
            const cvmAmount = parseFloat(document.getElementById('addLiqCvmAmount').value);
            
            if (!tokenAmount || tokenAmount <= 0) {
                showAddLiquidityStatus('Please enter a valid token amount', 'error');
                return;
            }
            
            if (!cvmAmount || cvmAmount <= 0) {
                showAddLiquidityStatus('Please enter a valid CVM amount', 'error');
                return;
            }
            
            // Check balances
            const cvmBalance = await getCvmBalance(account);
            const tokenBalance = await getTokenBalance(account, selectedToken.tokenAddress);
            
            if (cvmBalance < cvmAmount + 0.01) { // +0.01 for fees
                showAddLiquidityStatus('Insufficient CVM balance (need extra for fees)', 'error');
                return;
            }
            
            if (tokenBalance < tokenAmount) {
                showAddLiquidityStatus(`Insufficient ${selectedToken.symbol} balance`, 'error');
                return;
            }
            
            try {
                showAddLiquidityStatus('Adding liquidity...', 'info');
                
                // Convert to smallest units
                const tokenAmountUnits = Math.floor(tokenAmount * 1000000); // 6 decimals
                const cvmAmountUnits = Math.floor(cvmAmount * 1000000000); // 9 decimals
                
                // Build transaction
                const source = `(do
  (import torus.exchange :as torus)
  (torus/add-liquidity ${selectedToken.tokenAddress} ${tokenAmountUnits} ${cvmAmountUnits}))`;
                
                console.log('Adding liquidity:', {tokenAmount, cvmAmount, source});
                
                await submitTx(source, 0);
                
                showAddLiquidityStatus('Liquidity added successfully!', 'success');
                
                // Refresh balances and pool info
                await updateBalances();
                const poolInfo = await getPoolInfo(selectedToken.tokenAddress, selectedToken.marketAddress, selectedToken.symbol);
                await displayPoolInfo(poolInfo);
                
                // Clear form
                setTimeout(() => {
                    hideAddLiquidity();
                }, 2000);
                
            } catch (error) {
                console.error('Add liquidity error:', error);
                showAddLiquidityStatus('Failed to add liquidity: ' + error.message, 'error');
            }
        }
        
        function showAddLiquidityStatus(message, type) {
            const statusDiv = document.getElementById('addLiquidityStatus');
            const statusText = document.getElementById('addLiquidityStatusText');
            
            statusDiv.className = 'p-3 rounded-lg';
            statusDiv.classList.remove('hidden');
            
            if (type === 'success') {
                statusDiv.classList.add('bg-green-500/10', 'border', 'border-green-500/30');
                statusText.className = 'text-sm text-green-300';
            } else if (type === 'error') {
                statusDiv.classList.add('bg-red-500/10', 'border', 'border-red-500/30');
                statusText.className = 'text-sm text-red-300';
            } else {
                statusDiv.classList.add('bg-blue-500/10', 'border', 'border-blue-500/30');
                statusText.className = 'text-sm text-blue-300';
            }
            
            statusText.textContent = message;
        }
        
        // ============================================
        // REMOVE LIQUIDITY FUNCTIONS
        // ============================================
        
        let currentLpPosition = null; // Store current LP position data
        
        function showRemoveLiquidity() {
            if (!selectedToken) {
                showStatus('Please select a token first', 'error');
                return;
            }
            
            // Get current LP position data from the displayed values
            const lpTokens = parseFloat(document.getElementById('userLpTokens').textContent) || 0;
            const poolShare = document.getElementById('userPoolShare').textContent;
            const cvmAmount = document.getElementById('userLpCvm').textContent;
            const tokenAmount = document.getElementById('userLpTokenAmount').textContent;
            const tokenSymbol = document.getElementById('userLpTokenSymbol').textContent;
            
            if (lpTokens === 0) {
                showStatus('You have no liquidity to remove', 'error');
                return;
            }
            
            // Store position data for calculations
            currentLpPosition = {
                lpTokens: lpTokens,
                poolShare: poolShare,
                cvmAmount: parseFloat(cvmAmount.replace(' CVM', '')),
                tokenAmount: parseFloat(tokenAmount),
                tokenSymbol: tokenSymbol
            };
            
            // Populate modal with current position
            document.getElementById('removeLiquidityTokenName').textContent = selectedToken.symbol;
            document.getElementById('removeLiquidityMarketAddress').textContent = selectedToken.marketAddress;
            document.getElementById('removeCurrentLpTokens').textContent = lpTokens.toFixed(6);
            document.getElementById('removeCurrentPoolShare').textContent = poolShare;
            document.getElementById('removeCurrentCvm').textContent = cvmAmount;
            document.getElementById('removeCurrentTokenAmount').textContent = tokenAmount;
            document.getElementById('removeCurrentTokenSymbol').textContent = tokenSymbol;
            
            // Reset slider
            document.getElementById('removePercentageSlider').value = 0;
            document.getElementById('removePercentageDisplay').textContent = '0%';
            document.getElementById('removePreview').classList.add('hidden');
            document.getElementById('removeConfirmBtn').disabled = true;
            document.getElementById('removeLiquidityStatus').classList.add('hidden');
            
            // Show modal
            document.getElementById('removeLiquidityModal').style.display = 'flex';
        }
        
        function hideRemoveLiquidity() {
            document.getElementById('removeLiquidityModal').style.display = 'none';
            currentLpPosition = null;
        }
        
        function setRemovePercentage(percent) {
            document.getElementById('removePercentageSlider').value = percent;
            updateRemovePreview();
        }
        
        function updateRemovePreview() {
            const percentage = parseInt(document.getElementById('removePercentageSlider').value);
            document.getElementById('removePercentageDisplay').textContent = percentage + '%';
            
            if (percentage === 0) {
                document.getElementById('removePreview').classList.add('hidden');
                document.getElementById('removeConfirmBtn').disabled = true;
                return;
            }
            
            if (!currentLpPosition) return;
            
            // Calculate amounts to receive
            const cvmToReceive = (currentLpPosition.cvmAmount * percentage) / 100;
            const tokensToReceive = (currentLpPosition.tokenAmount * percentage) / 100;
            
            // Update preview
            document.getElementById('removePreviewCvm').textContent = cvmToReceive.toFixed(6) + ' CVM';
            document.getElementById('removePreviewTokenAmount').textContent = tokensToReceive.toFixed(6);
            document.getElementById('removePreviewTokenSymbol').textContent = currentLpPosition.tokenSymbol;
            
            // Show preview and enable button
            document.getElementById('removePreview').classList.remove('hidden');
            document.getElementById('removeConfirmBtn').disabled = false;
        }
        
        async function executeRemoveLiquidity() {
            if (!account || !wallet || !selectedToken || !currentLpPosition) {
                showRemoveLiquidityStatus('Please connect your wallet and select a token', 'error');
                return;
            }
            
            const percentage = parseInt(document.getElementById('removePercentageSlider').value);
            
            if (percentage === 0) {
                showRemoveLiquidityStatus('Please select an amount to remove', 'error');
                return;
            }
            
            try {
                showRemoveLiquidityStatus('Removing liquidity...', 'info');
                
                // Calculate LP tokens to withdraw (percentage of total)
                const lpTokensToWithdraw = (currentLpPosition.lpTokens * percentage) / 100;
                const lpTokensUnits = Math.floor(lpTokensToWithdraw * 1000000); // 6 decimals
                
                // Build transaction using Torus withdraw-liquidity
                const source = `(do
  (import torus.exchange :as torus)
  (torus/withdraw-liquidity ${selectedToken.tokenAddress} ${lpTokensUnits}))`;
                
                console.log('Removing liquidity:', {percentage, lpTokensToWithdraw, lpTokensUnits, source});
                
                await submitTx(source, 0);
                
                showRemoveLiquidityStatus(`Successfully removed ${percentage}% of your liquidity!`, 'success');
                
                // Refresh balances and pool info
                await updateBalances();
                const poolInfo = await getPoolInfo(selectedToken.tokenAddress, selectedToken.marketAddress, selectedToken.symbol);
                await displayPoolInfo(poolInfo);
                
                // Close modal after success
                setTimeout(() => {
                    hideRemoveLiquidity();
                }, 2000);
                
            } catch (error) {
                console.error('Remove liquidity error:', error);
                showRemoveLiquidityStatus('Failed to remove liquidity: ' + error.message, 'error');
            }
        }
        
        function showRemoveLiquidityStatus(message, type) {
            const statusDiv = document.getElementById('removeLiquidityStatus');
            const statusText = document.getElementById('removeLiquidityStatusText');
            
            statusDiv.className = 'p-3 rounded-lg';
            statusDiv.classList.remove('hidden');
            
            if (type === 'success') {
                statusDiv.classList.add('bg-green-500/10', 'border', 'border-green-500/30');
                statusText.className = 'text-sm text-green-300';
            } else if (type === 'error') {
                statusDiv.classList.add('bg-red-500/10', 'border', 'border-red-500/30');
                statusText.className = 'text-sm text-red-300';
            } else {
                statusDiv.classList.add('bg-blue-500/10', 'border', 'border-blue-500/30');
                statusText.className = 'text-sm text-blue-300';
            }
            
            statusText.textContent = message;
        }
        
        // ============================================
        // QUICK CREATE TOKEN FUNCTIONS
        // ============================================
        
        function showQuickCreateToken() {
            // Hide the add token panel
            hideAddToken();
            
            // Reset form
            document.getElementById('quickTokenTicker').value = '';
            document.getElementById('quickTokenSupply').value = '';
            document.getElementById('quickTokenLiquidity').value = '';
            document.getElementById('quickCvmLiquidity').value = '';
            document.getElementById('quickCreateResult').classList.add('hidden');
            document.getElementById('quickCreateStatus').classList.add('hidden');
            
            // Show modal
            document.getElementById('quickCreateTokenModal').style.display = 'flex';
        }
        
        function hideQuickCreateToken() {
            document.getElementById('quickCreateTokenModal').style.display = 'none';
        }
        
        function closeQuickCreateSuccess() {
            hideQuickCreateToken();
            // Optionally scroll back to swap interface
            document.querySelector('.max-w-md.mx-auto.card-glass').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        }
        
        async function executeQuickCreateToken() {
            if (!account || !wallet || !wallet.keyPair) {
                showQuickCreateStatus('Please connect your wallet first', 'error');
                return;
            }
            
            // Get form values
            const ticker = document.getElementById('quickTokenTicker').value.trim().toUpperCase();
            const supply = parseInt(document.getElementById('quickTokenSupply').value);
            const tokenLiq = parseFloat(document.getElementById('quickTokenLiquidity').value) || 0;
            const cvmLiq = parseFloat(document.getElementById('quickCvmLiquidity').value) || 0;
            
            // Validate inputs
            if (!ticker || ticker.length < 2 || ticker.length > 10) {
                showQuickCreateStatus('Please enter a valid ticker (2-10 characters)', 'error');
                return;
            }
            
            if (!supply || supply < 1) {
                showQuickCreateStatus('Please enter a valid supply (minimum 1)', 'error');
                return;
            }
            
            // Check if adding liquidity
            const addingLiquidity = tokenLiq > 0 && cvmLiq > 0;
            
            if (addingLiquidity) {
                if (tokenLiq > supply) {
                    showQuickCreateStatus('Token liquidity cannot exceed total supply', 'error');
                    return;
                }
                
                // Check CVM balance
                const balance = await getCvmBalance(account);
                const requiredBalance = cvmLiq + 0.05; // CVM + fees
                if (balance < requiredBalance) {
                    showQuickCreateStatus(`Insufficient balance. Need ${requiredBalance.toFixed(4)} CVM (including fees)`, 'error');
                    return;
                }
            } else {
                // Just creating token, no liquidity
                const balance = await getCvmBalance(account);
                if (balance < 0.05) {
                    showQuickCreateStatus('Insufficient balance. Need ~0.05 CVM for fees', 'error');
                    return;
                }
            }
            
            try {
                showQuickCreateStatus('Creating your token...', 'info');
                
                // Convert to smallest units
                const supplyUnits = Math.floor(supply * 1000000); // 6 decimals
                
                let source;
                
                if (addingLiquidity) {
                    // Create token WITH liquidity
                    const tokenLiqUnits = Math.floor(tokenLiq * 1000000);
                    const cvmLiqUnits = Math.floor(cvmLiq * 1000000000);
                    
                    source = `(do
  (import convex.fungible :as fungible)
  (import torus.exchange :as torus)
  
  ;; Create token with full supply
  (def my-token (deploy (fungible/build-token {:supply ${supplyUnits}})))
  
  ;; Add liquidity - Torus automatically pulls tokens from token contract
  (torus/add-liquidity my-token ${tokenLiqUnits} ${cvmLiqUnits})
  
  ;; Return addresses
  {:token my-token 
   :market (torus/get-market my-token)})`;
                    
                } else {
                    // Create token WITHOUT liquidity (just mint)
                    source = `(do
  (import convex.fungible :as fungible)
  
  ;; Create token with full supply  
  (def my-token (deploy (fungible/build-token {:supply ${supplyUnits}})))
  
  ;; Return token address
  {:token my-token})`;
                }
                
                console.log('Quick creating token:', {ticker, supply, tokenLiq, cvmLiq, addingLiquidity});
                console.log('Transaction source:', source);
                
                // Prepare transaction
                showQuickCreateStatus('Preparing transaction...', 'info');
                const prepareRes = await fetch(`${CONVEX_URL}/api/v1/transaction/prepare`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({address: account, source})
                });
                const prepareData = await prepareRes.json();
                
                if (!prepareData.hash) {
                    throw new Error('Failed to prepare transaction: ' + JSON.stringify(prepareData));
                }
                
                // Sign transaction
                showQuickCreateStatus('Signing transaction...', 'info');
                const hashBytes = hexToBytes(prepareData.hash);
                const signature = nacl.sign.detached(hashBytes, wallet.keyPair.secretKey);
                const signatureHex = bytesToHex(signature);
                
                // Submit transaction
                showQuickCreateStatus('Submitting to blockchain...', 'info');
                const submitRes = await fetch(`${CONVEX_URL}/api/v1/transaction/submit`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        hash: prepareData.hash,
                        accountKey: wallet.publicKey,
                        sig: signatureHex
                    })
                });
                const result = await submitRes.json();
                
                console.log('Transaction result:', result);
                
                if (result.errorCode) {
                    throw new Error(result.value || result.errorCode);
                }
                
                // Extract addresses
                const tokenAddress = '#' + result.value.token;
                const marketAddress = result.value.market ? '#' + result.value.market : null;
                
                console.log('Created:', {tokenAddress, marketAddress});
                
                // Show success
                document.getElementById('quickCreatedTokenName').textContent = ticker;
                document.getElementById('quickCreatedTokenAddress').textContent = tokenAddress;
                
                if (marketAddress) {
                    document.getElementById('quickCreatedMarketAddress').textContent = marketAddress;
                    document.getElementById('quickCreatedMarketSection').classList.remove('hidden');
                } else {
                    document.getElementById('quickCreatedMarketSection').classList.add('hidden');
                }
                
                document.getElementById('quickCreateResult').classList.remove('hidden');
                document.getElementById('quickCreateStatus').classList.add('hidden');
                
                // Automatically add to token list
                if (marketAddress) {
                    tokens.push({
                        tokenAddress: tokenAddress,
                        marketAddress: marketAddress,
                        symbol: ticker
                    });
                    localStorage.setItem('vortex_tokens', JSON.stringify(tokens));
                    updateTokenList();
                    console.log('‚úì Token automatically added to VorteX list');
                }
                
                // Update balance
                await updateBalances();
                
                showStatus(`Token ${ticker} created and listed on VorteX!`, 'success');
                
            } catch (error) {
                console.error('Quick create token error:', error);
                showQuickCreateStatus('Failed to create token: ' + error.message, 'error');
            }
        }
        
        function showQuickCreateStatus(message, type) {
            const statusDiv = document.getElementById('quickCreateStatus');
            const statusText = document.getElementById('quickCreateStatusText');
            
            statusDiv.className = 'p-3 rounded-lg';
            statusDiv.classList.remove('hidden');
            
            if (type === 'success') {
                statusDiv.classList.add('bg-green-500/10', 'border', 'border-green-500/30');
                statusText.className = 'text-sm text-green-300';
            } else if (type === 'error') {
                statusDiv.classList.add('bg-red-500/10', 'border', 'border-red-500/30');
                statusText.className = 'text-sm text-red-300';
            } else {
                statusDiv.classList.add('bg-blue-500/10', 'border', 'border-blue-500/30');
                statusText.className = 'text-sm text-blue-300';
            }
            
            statusText.textContent = message;
        }
        
        function showImportAccount() { showStep('stepImport'); }
        function backToStart() { showStep('step1'); }
        function showStep(id) {
            document.querySelectorAll('.step').forEach(s => s.style.display = 'none');
            document.getElementById(id).style.display = 'block';
        }
        
        async function doImport() {
            const input = document.getElementById('importKey').value.trim();
            
            if (!input) {
                alert('Please enter your private key');
                return;
            }
            
            try {
                if (input.length !== 64 || !/^[0-9a-fA-F]+$/.test(input)) {
                    throw new Error('Invalid private key format. Must be 64 hex characters.');
                }
                
                const privateKeyHex = input.toLowerCase();
                const seedBytes = hexToBytes(privateKeyHex);
                const keyPair = nacl.sign.keyPair.fromSeed(seedBytes);
                const publicKeyHex = bytesToHex(keyPair.publicKey);
                
                wallet = {
                    privateKey: privateKeyHex,
                    publicKey: publicKeyHex,
                    keyPair: keyPair
                };
                
                account = await findAccountByPublicKey(publicKeyHex);
                
                if (!account) {
                    const accNum = prompt('Could not auto-detect your account number.\n\nPlease enter your account number (e.g., 132):');
                    if (!accNum) throw new Error('Account number is required');
                    account = parseInt(accNum);
                    await getCvmBalance(account);
                }
                
                console.log('‚úì Connected to account #' + account);
                startDex();
                
            } catch (error) {
                console.error('Import error:', error);
                alert('Import failed:\n\n' + error.message);
            }
        }
        
        async function findAccountByPublicKey(pubKey) {
            try {
                const query = `(let [search-for 0x${pubKey} n (count (:accounts *state*))] (for-loop [i 0 (< i n) (inc i)] (cond (= search-for (:key (account (address i)))) (halt (address i)))))`;
                
                const response = await fetch(`${CONVEX_URL}/api/v1/query`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ address: 1, source: query })
                });
                
                const result = await response.json();
                return result.value || null;
            } catch (error) {
                console.error('Account lookup error:', error);
                return null;
            }
        }
        
        function startDex() {
            document.getElementById('walletModal').classList.remove('active');
            document.getElementById('dexInterface').style.display = 'block';
            document.getElementById('navAccount').textContent = '#' + account;
            updateTokenList();
            updateBalances();
        }
        
        function disconnect() {
            if (confirm('Disconnect from account #' + account + '?')) {
                wallet = null;
                account = null;
                selectedToken = null;
                swapDirection = 'cvm-to-token';
                document.getElementById('dexInterface').style.display = 'none';
                document.getElementById('walletModal').classList.add('active');
                showStep('step1');
            }
        }
        
        function reverseSwap() {
            if (!selectedToken) {
                alert('Please select a token first');
                return;
            }
            
            if (swapDirection === 'cvm-to-token') {
                swapDirection = 'token-to-cvm';
                document.getElementById('payLabel').textContent = 'You sell';
                document.getElementById('receiveLabel').textContent = 'You receive';
                
                document.getElementById('payCurrencySelector').style.display = 'none';
                document.getElementById('payTokenSelector').style.display = 'block';
                const selectedText = document.getElementById('receiveSelectedTokenText').textContent;
                document.getElementById('paySelectedTokenText').textContent = selectedText;
                
                document.getElementById('receiveTokenSelector').style.display = 'none';
                document.getElementById('receiveCurrencySelector').style.display = 'block';
                
            } else {
                swapDirection = 'cvm-to-token';
                document.getElementById('payLabel').textContent = 'You pay';
                document.getElementById('receiveLabel').textContent = 'You receive (estimated)';
                
                document.getElementById('payCurrencySelector').style.display = 'block';
                document.getElementById('payTokenSelector').style.display = 'none';
                
                document.getElementById('receiveTokenSelector').style.display = 'block';
                document.getElementById('receiveCurrencySelector').style.display = 'none';
            }
            
            document.getElementById('payAmount').value = '';
            document.getElementById('receiveAmount').value = '';
            
            updateBalances();
            
            console.log('Swapped direction to:', swapDirection);
        }
        
        async function updateBalances() {
            if (!account) return;
            
            try {
                const cvmBalance = await getCvmBalance(account);
                
                if (swapDirection === 'cvm-to-token') {
                    document.getElementById('payBalance').textContent = cvmBalance.toFixed(4) + ' CVM';
                } else {
                    if (selectedToken) {
                        const tokenBalance = await getTokenBalance(account, selectedToken.tokenAddress);
                        document.getElementById('payBalance').textContent = tokenBalance.toFixed(4) + ' ' + selectedToken.symbol;
                    } else {
                        document.getElementById('payBalance').textContent = 'Select token...';
                    }
                }
                
                document.getElementById('swapBtn').disabled = !selectedToken;
                document.getElementById('swapBtnText').textContent = selectedToken ? 'Swap Tokens' : 'Select a token to swap';
            } catch (error) {
                console.error('Balance update error:', error);
                document.getElementById('payBalance').textContent = 'Error';
            }
        }
        
        async function setMaxAmount() {
            if (!account) {
                alert('Please connect your account first');
                return;
            }
            
            try {
                let maxBalance = 0;
                
                if (swapDirection === 'cvm-to-token') {
                    maxBalance = await getCvmBalance(account);
                    maxBalance = Math.max(0, maxBalance - 0.0001);
                } else {
                    if (!selectedToken) {
                        alert('Please select a token first');
                        return;
                    }
                    maxBalance = await getTokenBalance(account, selectedToken.tokenAddress);
                }
                
                document.getElementById('payAmount').value = maxBalance.toFixed(6);
                
                await calculateSwap();
                
                console.log('‚úì Set max amount:', maxBalance);
                
            } catch (error) {
                console.error('Error setting max amount:', error);
                alert('Could not get balance: ' + error.message);
            }
        }
        
        async function getCvmBalance(addr) {
            const res = await fetch(`${CONVEX_URL}/api/v1/accounts/${addr}`);
            if (!res.ok) throw new Error('Account not found');
            const data = await res.json();
            return data.balance ? data.balance / 1000000000 : 0;
        }
        
        async function getTokenBalance(userAddr, tokenAddr) {
            try {
                const query = `(call ${tokenAddr} (balance #${userAddr}))`;
                
                const res = await fetch(`${CONVEX_URL}/api/v1/query`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({address: userAddr, source: query})
                });
                const data = await res.json();
                
                console.log('Token balance query:', data);
                
                if (data.value && typeof data.value === 'number') {
                    return data.value / 1000000;
                } else {
                    console.warn('Token balance error:', data);
                    return 0;
                }
            } catch (error) {
                console.error('Token balance error:', error);
                return 0;
            }
        }
        
        async function calculateSwap() {
            const payAmt = parseFloat(document.getElementById('payAmount').value) || 0;
            
            if (payAmt <= 0 || !selectedToken) {
                document.getElementById('receiveAmount').value = '';
                return;
            }
            
            try {
                if (swapDirection === 'cvm-to-token') {
                    const coppers = Math.floor(payAmt * 1000000000);
                    const query = `(call ${selectedToken.marketAddress} (sell-cvx-quote ${coppers}))`;
                    
                    const res = await fetch(`${CONVEX_URL}/api/v1/query`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({address: account, source: query})
                    });
                    const data = await res.json();
                    
                    if (data.value && typeof data.value === 'number') {
                        document.getElementById('receiveAmount').value = (data.value / 1000000).toFixed(6);
                    } else {
                        document.getElementById('receiveAmount').value = '0.00';
                    }
                    
                } else {
                    const tokenAmount = Math.floor(payAmt * 1000000);
                    const query = `(call ${selectedToken.marketAddress} (sell-tokens-quote ${tokenAmount}))`;
                    
                    const res = await fetch(`${CONVEX_URL}/api/v1/query`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({address: account, source: query})
                    });
                    const data = await res.json();
                    
                    console.log('Sell tokens quote:', data);
                    
                    if (data.value && typeof data.value === 'number') {
                        document.getElementById('receiveAmount').value = (data.value / 1000000000).toFixed(6);
                    } else {
                        document.getElementById('receiveAmount').value = '0.00';
                        if (data.errorCode) {
                            console.warn('Quote error:', data.value);
                        }
                    }
                }
            } catch (error) {
                console.error('Quote error:', error);
                document.getElementById('receiveAmount').value = '0.00';
            }
        }
        
        async function executeSwap() {
            const payAmt = parseFloat(document.getElementById('payAmount').value);
            
            if (!payAmt || !selectedToken) {
                showStatus('Please enter an amount and select a token', 'error');
                return;
            }
            
            try {
                showStatus('Executing swap...', 'info');
                
                if (swapDirection === 'cvm-to-token') {
                    const coppers = Math.floor(payAmt * 1000000000);
                    const source = `(call ${selectedToken.marketAddress} ${coppers} (sell-cvx ${coppers}))`;
                    
                    console.log('Executing:', source);
                    await submitTx(source, 0);
                    
                } else {
                    const tokenAmount = Math.floor(payAmt * 1000000);
                    const source = `(call ${selectedToken.marketAddress} (sell-tokens ${tokenAmount}))`;
                    
                    console.log('Executing:', source);
                    await submitTx(source, 0);
                }
                
                showStatus('Swap successful!', 'success');
                document.getElementById('payAmount').value = '';
                document.getElementById('receiveAmount').value = '';
                await updateBalances();
                
                if (selectedToken) {
                    getPoolInfo(selectedToken.tokenAddress, selectedToken.marketAddress, selectedToken.symbol)
                        .then(poolInfo => displayPoolInfo(poolInfo))
                        .catch(error => console.error('Failed to refresh pool info:', error));
                }
                
            } catch (error) {
                console.error('Swap error:', error);
                showStatus('Swap failed: ' + error.message, 'error');
            }
        }
        
        async function submitTx(source, value = 0) {
            console.log('Submitting transaction:', source);
            
            const accData = await fetch(`${CONVEX_URL}/api/v1/accounts/${account}`).then(r => r.json());
            const sequence = accData.sequence + 1;
            
            const prepareBody = {
                address: account.toString(),
                source: source,
                sequence: sequence
            };
            
            const prepareRes = await fetch(`${CONVEX_URL}/api/v1/transaction/prepare`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(prepareBody)
            });
            
            const prepareData = await prepareRes.json();
            
            if (!prepareData.hash) {
                throw new Error('Failed to prepare transaction');
            }
            
            const hashBytes = hexToBytes(prepareData.hash);
            const signature = nacl.sign.detached(hashBytes, wallet.keyPair.secretKey);
            const sigHex = bytesToHex(signature);
            
            const submitBody = {
                hash: prepareData.hash,
                accountKey: wallet.publicKey,
                sig: sigHex
            };
            
            const result = await fetch(`${CONVEX_URL}/api/v1/transaction/submit`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(submitBody)
            }).then(r => r.json());
            
            console.log('Transaction result:', result);
            
            if (result.errorCode) {
                throw new Error(result.value || 'Transaction failed');
            }
            
            return result;
        }
        
        function loadTokens() {
            const saved = localStorage.getItem('vortex_tokens');
            if (saved) {
                tokens = JSON.parse(saved);
                updateTokenList();
            }
        }
        
        function showAddToken() {
            const panel = document.getElementById('addTokenPanel');
            panel.style.display = 'block';
            // Smooth scroll to the panel
            setTimeout(() => {
                panel.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        }
        
        function showCreateToken() {
            document.getElementById('createTokenModal').style.display = 'flex';
            document.getElementById('newTokenTicker').value = '';
            document.getElementById('newTokenSupply').value = '';
            document.getElementById('newTokenLiquidity').value = '';
            document.getElementById('newCvmLiquidity').value = '';
            document.getElementById('createTokenResult').classList.add('hidden');
            document.getElementById('createTokenStatus').classList.add('hidden');
        }
        
        function hideCreateToken() {
            document.getElementById('createTokenModal').style.display = 'none';
        }
        
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent;
            navigator.clipboard.writeText(text).then(() => {
                showStatus('Copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Copy failed:', err);
                showStatus('Failed to copy', 'error');
            });
        }
        
        async function createTokenAndMarket() {
            if (!account || !wallet || !wallet.keyPair) {
                showStatus('Please import your account first', 'error');
                return;
            }
            
            const ticker = document.getElementById('newTokenTicker').value.trim().toUpperCase();
            const supply = parseInt(document.getElementById('newTokenSupply').value);
            const tokenLiq = parseFloat(document.getElementById('newTokenLiquidity').value);
            const cvmLiq = parseFloat(document.getElementById('newCvmLiquidity').value);
            
            if (!ticker || ticker.length < 2 || ticker.length > 10) {
                showCreateTokenStatus('Please enter a valid ticker (2-10 characters)', 'error');
                return;
            }
            
            if (!supply || supply < 1) {
                showCreateTokenStatus('Please enter a valid supply (minimum 1)', 'error');
                return;
            }
            
            if (!tokenLiq || tokenLiq < 0 || tokenLiq > supply) {
                showCreateTokenStatus('Token liquidity must be between 0 and total supply', 'error');
                return;
            }
            
            if (!cvmLiq || cvmLiq <= 0) {
                showCreateTokenStatus('CVM liquidity must be greater than 0', 'error');
                return;
            }
            
            const balance = await getCvmBalance(account);
            const requiredBalance = cvmLiq + 0.05;
            if (balance < requiredBalance) {
                showCreateTokenStatus(`Insufficient balance. Need ${requiredBalance.toFixed(4)} CVM (including fees)`, 'error');
                return;
            }
            
            try {
                showCreateTokenStatus('Creating token and market...', 'info');
                
                const supplyUnits = Math.floor(supply * 1000000);
                const tokenLiqUnits = Math.floor(tokenLiq * 1000000);
                const cvmLiqUnits = Math.floor(cvmLiq * 1000000000);
                
                const source = `(do
  (import convex.fungible :as fungible)
  (import torus.exchange :as torus)
  
  (def my-token (deploy (fungible/build-token {:supply ${supplyUnits}})))
  
  (call my-token (transfer *address* ${supplyUnits - tokenLiqUnits}))
  
  (torus/add-liquidity my-token ${tokenLiqUnits} ${cvmLiqUnits})
  
  {:token my-token 
   :market (torus/get-market my-token)})`;
                
                console.log('Creating token:', {ticker, supply, tokenLiq, cvmLiq});
                console.log('Transaction source:', source);
                
                showCreateTokenStatus('Preparing transaction...', 'info');
                const prepareRes = await fetch(`${CONVEX_URL}/api/v1/transaction/prepare`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({address: account, source})
                });
                const prepareData = await prepareRes.json();
                
                if (!prepareData.hash) {
                    throw new Error('Failed to prepare transaction: ' + JSON.stringify(prepareData));
                }
                
                console.log('Transaction prepared:', prepareData);
                
                showCreateTokenStatus('Signing transaction...', 'info');
                const hashBytes = hexToBytes(prepareData.hash);
                const signature = nacl.sign.detached(hashBytes, wallet.keyPair.secretKey);
                const signatureHex = bytesToHex(signature);
                
                showCreateTokenStatus('Submitting to blockchain...', 'info');
                const submitRes = await fetch(`${CONVEX_URL}/api/v1/transaction/submit`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        hash: prepareData.hash,
                        accountKey: wallet.publicKey,
                        sig: signatureHex
                    })
                });
                const result = await submitRes.json();
                
                console.log('Transaction result:', result);
                
                if (result.errorCode) {
                    throw new Error(result.value || result.errorCode);
                }
                
                const tokenAddress = '#' + result.value.token;
                const marketAddress = '#' + result.value.market;
                
                console.log('Created:', {tokenAddress, marketAddress});
                
                document.getElementById('createdTokenAddress').textContent = tokenAddress;
                document.getElementById('createdMarketAddress').textContent = marketAddress;
                document.getElementById('createTokenResult').classList.remove('hidden');
                document.getElementById('createTokenStatus').classList.add('hidden');
                
                await updateBalances();
                
                showStatus(`Token ${ticker} created successfully!`, 'success');
                
            } catch (error) {
                console.error('Create token error:', error);
                showCreateTokenStatus('Failed to create token: ' + error.message, 'error');
            }
        }
        
        function showCreateTokenStatus(message, type) {
            const statusDiv = document.getElementById('createTokenStatus');
            const statusText = document.getElementById('createTokenStatusText');
            
            statusDiv.className = 'p-3 rounded-lg';
            statusDiv.classList.remove('hidden');
            
            if (type === 'success') {
                statusDiv.classList.add('bg-green-500/10', 'border', 'border-green-500/30');
                statusText.className = 'text-sm text-green-300';
            } else if (type === 'error') {
                statusDiv.classList.add('bg-red-500/10', 'border', 'border-red-500/30');
                statusText.className = 'text-sm text-red-300';
            } else {
                statusDiv.classList.add('bg-blue-500/10', 'border', 'border-blue-500/30');
                statusText.className = 'text-sm text-blue-300';
            }
            
            statusText.textContent = message;
        }
        
        function hideAddToken() {
            document.getElementById('addTokenPanel').style.display = 'none';
            document.getElementById('tokenAddressInput').value = '';
            document.getElementById('marketAddressInput').value = '';
            document.getElementById('tokenSymbolInput').value = '';
        }
        
        function toggleTokenList() {
            const panel = document.getElementById('tokenListPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }
        
        async function getPoolInfo(tokenAddress, marketAddress, tokenSymbol) {
            try {
                console.log('üìä Getting pool info for token', tokenAddress, 'market', marketAddress);
                
                const stateQuery = `{
                    :token-balance (call ${tokenAddress} (balance ${marketAddress}))
                    :cvm-balance (balance ${marketAddress})
                    :lp-supply (call ${marketAddress} (total-supply))
                }`;
                
                console.log('Pool state query:', stateQuery);
                
                const stateRes = await fetch(`${CONVEX_URL}/api/v1/query`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({address: account || 1, source: stateQuery})
                });
                const stateData = await stateRes.json();
                
                console.log('Pool state response:', stateData);
                
                if (!stateData.value) {
                    console.error('Pool state error:', stateData);
                    throw new Error('Failed to get pool state: ' + (stateData.errorCode || 'Unknown error'));
                }
                
                const tokenBalance = stateData.value['token-balance'] || 0;
                const cvmBalance = stateData.value['cvm-balance'] || 0;
                const lpSupply = stateData.value['lp-supply'] || 0;
                
                console.log('Raw values:', {tokenBalance, cvmBalance, lpSupply});
                
                const tokenBalanceFloat = tokenBalance / 1000000;
                const cvmBalanceFloat = cvmBalance / 1000000000;
                
                let pricePerToken = 0;
                let tokensPerCvm = 0;
                
                if (tokenBalanceFloat > 0 && cvmBalanceFloat > 0) {
                    pricePerToken = cvmBalanceFloat / tokenBalanceFloat;
                    tokensPerCvm = tokenBalanceFloat / cvmBalanceFloat;
                }
                
                console.log('Calculated prices:', {pricePerToken, tokensPerCvm});
                
                let userLpBalance = 0;
                if (account) {
                    try {
                        const lpQuery = `(call ${marketAddress} (balance #${account}))`;
                        console.log('LP balance query:', lpQuery);
                        
                        const lpRes = await fetch(`${CONVEX_URL}/api/v1/query`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({address: account, source: lpQuery})
                        });
                        const lpData = await lpRes.json();
                        console.log('LP balance response:', lpData);
                        
                        userLpBalance = lpData.value || 0;
                        console.log('User LP balance:', userLpBalance);
                    } catch (error) {
                        console.warn('Could not get LP balance:', error);
                    }
                }
                
                return {
                    tokenBalance: tokenBalanceFloat,
                    cvmBalance: cvmBalanceFloat,
                    lpSupply: lpSupply / 1000000,
                    pricePerToken,
                    tokensPerCvm,
                    userLpBalance: userLpBalance / 1000000,
                    tokenSymbol
                };
                
            } catch (error) {
                console.error('Pool info error:', error);
                throw error;
            }
        }
        
        async function displayPoolInfo(poolInfo) {
            try {
                const poolPanel = document.getElementById('poolInfoPanel');
                if (!poolPanel) {
                    console.error('Pool info panel not found');
                    return;
                }
                poolPanel.style.display = 'block';
                
                const safeSetText = (id, text) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = text;
                    else console.warn(`Element ${id} not found`);
                };
                
                safeSetText('poolCvmAmount', poolInfo.cvmBalance.toFixed(4) + ' CVM');
                safeSetText('poolTokenAmount', poolInfo.tokenBalance.toFixed(4));
                safeSetText('poolTokenSymbol', poolInfo.tokenSymbol);
                
                const totalLiquidityCvm = (poolInfo.cvmBalance * 2).toFixed(2);
                safeSetText('poolTotalLiquidity', totalLiquidityCvm + ' CVM');
                
                safeSetText('priceTokenSymbol1', poolInfo.tokenSymbol);
                safeSetText('price1Token', poolInfo.pricePerToken.toFixed(6) + ' CVM');
                safeSetText('price1Cvm', poolInfo.tokensPerCvm.toFixed(6) + ' ' + poolInfo.tokenSymbol);
                
                if (poolInfo.userLpBalance > 0 && poolInfo.lpSupply > 0) {
                    const poolShare = (poolInfo.userLpBalance / poolInfo.lpSupply) * 100;
                    const userCvm = (poolInfo.cvmBalance * poolInfo.userLpBalance) / poolInfo.lpSupply;
                    const userTokens = (poolInfo.tokenBalance * poolInfo.userLpBalance) / poolInfo.lpSupply;
                    
                    safeSetText('userLpTokens', poolInfo.userLpBalance.toFixed(6));
                    safeSetText('userPoolShare', poolShare.toFixed(4) + '%');
                    safeSetText('userLpCvm', userCvm.toFixed(6) + ' CVM');
                    safeSetText('userLpTokenAmount', userTokens.toFixed(6));
                    safeSetText('userLpTokenSymbol', poolInfo.tokenSymbol);
                    
                    const lpSection = document.getElementById('lpPositionSection');
                    const noLpSection = document.getElementById('noLpPosition');
                    if (lpSection) lpSection.style.display = 'block';
                    if (noLpSection) noLpSection.style.display = 'none';
                } else {
                    const lpSection = document.getElementById('lpPositionSection');
                    const noLpSection = document.getElementById('noLpPosition');
                    if (lpSection) lpSection.style.display = 'none';
                    if (noLpSection) noLpSection.style.display = 'block';
                }
                
                console.log('‚úì Pool info displayed');
                
            } catch (error) {
                console.error('Display pool info error:', error);
            }
        }
        
        async function refreshPoolInfo() {
            if (!selectedToken) {
                showStatus('Please select a token first', 'error');
                return;
            }
            
            try {
                showStatus('Refreshing pool info...', 'info');
                const poolInfo = await getPoolInfo(selectedToken.tokenAddress, selectedToken.marketAddress, selectedToken.symbol);
                await displayPoolInfo(poolInfo);
                showStatus('Pool info updated', 'success');
            } catch (error) {
                console.error('Refresh pool info error:', error);
                showStatus('Failed to refresh pool info', 'error');
            }
        }
        
        function selectToken(tokenObj) {
            selectedToken = tokenObj;
            const displayText = `${tokenObj.symbol} (Market: ${tokenObj.marketAddress})`;
            document.getElementById('receiveSelectedTokenText').textContent = displayText;
            document.getElementById('paySelectedTokenText').textContent = displayText;
            document.getElementById('tokenListPanel').style.display = 'none';
             document.getElementById('addLiquidityBtn').style.display = 'block';
            
            // Update the Create/Liquidity button
            updateCreateOrLiquidityButton();
            
            updateBalances();
            calculateSwap();
            
            getPoolInfo(tokenObj.tokenAddress, tokenObj.marketAddress, tokenObj.symbol)
                .then(poolInfo => displayPoolInfo(poolInfo))
                .catch(error => {
                    console.error('Failed to load pool info:', error);
                    document.getElementById('poolInfoPanel').style.display = 'none';
                });
        }
        
        function deleteToken(index) {
            if (confirm('Remove this token from your list?')) {
                const deletedToken = tokens[index];
                tokens.splice(index, 1);
                localStorage.setItem('vortex_tokens', JSON.stringify(tokens));
                
                if (selectedToken && selectedToken.marketAddress === deletedToken.marketAddress) {
                    selectedToken = null;
                    document.getElementById('receiveSelectedTokenText').textContent = 'Select token...';
                    document.getElementById('paySelectedTokenText').textContent = 'Select token...';
                    document.getElementById('addLiquidityBtn').style.display = 'none';
                    updateBalances();
                }
                
                updateTokenList();
                showStatus('Token removed', 'success');
            }
        }
        
        function updateTokenList() {
            const container = document.getElementById('tokenListItems');
            
            if (tokens.length === 0) {
                container.innerHTML = '<div class="text-center text-white/50 text-sm py-4">No tokens added yet</div>';
                return;
            }
            
            container.innerHTML = '';
            tokens.forEach((t, index) => {
                const isSelected = selectedToken && selectedToken.marketAddress === t.marketAddress;
                const item = document.createElement('div');
                item.className = 'token-item' + (isSelected ? ' selected' : '');
                const tokenObjStr = JSON.stringify(t).replace(/"/g, '&quot;');
                item.innerHTML = `
                    <div onclick='selectToken(${tokenObjStr})' class="flex-1">
                        <div class="font-medium">${t.symbol}</div>
                        <div class="text-xs text-white/60">Market: ${t.marketAddress}</div>
                    </div>
                    <button onclick="deleteToken(${index})" class="delete-btn text-red-400 hover:text-red-300 px-2">
                        üóëÔ∏è
                    </button>
                `;
                container.appendChild(item);
            });
        }
        
        async function addToken() {
            const tokenAddr = document.getElementById('tokenAddressInput').value.trim();
            const marketAddr = document.getElementById('marketAddressInput').value.trim();
            const symbol = document.getElementById('tokenSymbolInput').value.trim().toUpperCase();
            
            if (!tokenAddr.startsWith('#')) {
                alert('Token address must start with # (e.g., #128)');
                return;
            }
            
            if (!marketAddr.startsWith('#')) {
                alert('Market address must start with # (e.g., #129)');
                return;
            }
            
            if (!symbol) {
                alert('Please enter a token symbol');
                return;
            }
            
            const exists = tokens.find(t => t.marketAddress === marketAddr);
            if (exists) {
                alert('This market is already in your list');
                return;
            }
            
            tokens.push({
                tokenAddress: tokenAddr,
                marketAddress: marketAddr, 
                symbol: symbol
            });
            localStorage.setItem('vortex_tokens', JSON.stringify(tokens));
            updateTokenList();
            hideAddToken();
            showStatus('Token added: ' + symbol + ' (Token: ' + tokenAddr + ', Market: ' + marketAddr + ')', 'success');
        }
        
        function showStatus(msg, type) {
            const div = document.getElementById('statusMsg');
            const text = document.getElementById('statusText');
            div.classList.remove('hidden', 'bg-blue-500/20', 'bg-green-500/20', 'bg-red-500/20');
            div.classList.add(type === 'success' ? 'bg-green-500/20' : type === 'error' ? 'bg-red-500/20' : 'bg-blue-500/20');
            text.textContent = msg;
            div.classList.remove('hidden');
            if (type === 'success') {
                setTimeout(() => div.classList.add('hidden'), 5000);
            }
        }
        
        function hexToBytes(hex) {
            hex = hex.replace(/^0x/, '');
            const bytes = new Uint8Array(hex.length / 2);
            for (let i = 0; i < hex.length; i += 2) {
                bytes[i / 2] = parseInt(hex.substr(i, 2), 16);
            }
            return bytes;
        }
        
        function bytesToHex(bytes) {
            return Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join('');
        }
    </script>
</body>
</html>
